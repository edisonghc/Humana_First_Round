---
title: 'Humana First Round Report'
author: "Edison Gu"
date: "03/01/2020"
output: html_document
---

```{r setup, include = F}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, cache = TRUE)

## Load libraries
library(tidyverse)
library(tibble)
library(janitor)
library(lubridate)
library(GGally)

#library(alr4)
#library(broom)
# library(ggpubr)

## Read in data
library(readxl)
demo_df <- read_excel("Humana Case 2020 Q1 -- Data.xlsx", 
     sheet = "Demographics", col_types = c("text", 
         "numeric", "numeric", "numeric", 
         "numeric", "text", "text", "text", 
         "numeric", "numeric", "text", "text"))

claims_df <- read_excel("Humana Case 2020 Q1 -- Data.xlsx", 
    sheet = "Claims")

er_df <- read_excel("Humana Case 2020 Q1 -- Data.xlsx", 
    sheet = "ER Utilization")

pcp_df <- read_excel("Humana Case 2020 Q1 -- Data.xlsx", 
    sheet = "PCP Visits")

hospital_df <- read_excel("Humana Case 2020 Q1 -- Data.xlsx", 
    sheet = "Hospital Admissions")

rx_df <- read_excel("Humana Case 2020 Q1 -- Data.xlsx", 
    sheet = "Rx Utilization")
```

```{r Data Integration}
## Format data
claims = claims_df %>% 
        pivot_longer(-id, names_to = "time", values_to = "agg_claim") %>% 
        transmute(id = as.character(id),
               time = excel_numeric_to_date(as.numeric(time), 
                                            date_system = "modern" ),
               agg_claim)
        
er = er_df %>% 
        pivot_longer(-id, names_to = "time", values_to = "count") %>% 
        transmute(id = as.character(id),
               time = excel_numeric_to_date(as.numeric(time), 
                                            date_system = "modern" ),
               er_count = count)

pcp = pcp_df %>% 
        pivot_longer(-id, names_to = "time", values_to = "count") %>% 
        transmute(id = as.character(id),
               time = excel_numeric_to_date(as.numeric(time), 
                                            date_system = "modern" ),
               pcp_count = count)

hospital = hospital_df %>% 
        pivot_longer(-id, names_to = "time", values_to = "count") %>% 
        transmute(id = as.character(id),
               time = excel_numeric_to_date(as.numeric(time), 
                                            date_system = "modern" ),
               hospital_count = count)

rx = rx_df %>% 
        pivot_longer(-id, names_to = "time", values_to = "count") %>% 
        transmute(id = as.character(id),
               time = excel_numeric_to_date(as.numeric(time), 
                                            date_system = "modern" ),
               rx_count = count)

## Join utilization and claim tables
loss = er %>% 
    inner_join(hospital, by = c("id"="id","time"="time")) %>% 
    inner_join(pcp, by = c("id"="id","time"="time")) %>% 
    inner_join(rx, by = c("id"="id","time"="time")) %>% 
    inner_join(claims, by = c("id"="id","time"="time")) %>% 
    mutate(total_count = er_count+hospital_count+pcp_count+rx_count,
           avg_claim = ifelse(agg_claim*total_count!=0,agg_claim/total_count,0))
```

```{r Data Cleaning}
## Check: each individual either get one or none CRD
demo_df %>% mutate(test_sum = transport+fin_assis+lonely+food_insec) %>% 
        filter(test_sum > 1)

## Check: region
demo_df %>% group_by(region) %>% 
    count() %>% arrange(n) # unknown small, ignore

## Check: rural
demo_df %>% group_by(rural) %>% 
    count() %>% arrange(n) # unknown small, ignore

## Check: is_lowincome
demo_df %>% group_by(is_lowincome) %>% 
    count() %>% arrange(n) # inconsistant label, need to fix

## Check: age
demo_df %>% group_by(age) %>% count() %>% filter(age<5) %>% arrange(age) # need to correct negative values, assume mistyped minues sign
demo_df %>% group_by(age) %>% count() %>% filter(age>95) %>% arrange(age) # need to correct >100 values, assume mistyped a 1 in the front

## Check: chronic_count
demo_df %>% group_by(chronic_count) %>% count() %>% arrange(chronic_count) # assume mistyped a 1 in the front

## Check: gender
demo_df %>% group_by(gender) %>% count() %>% arrange(n) # will just ignore other than M, F
    
demo = demo_df %>% 
    mutate(is_lowincome = demo_df$is_lowincome %in% c("Y","Yes","YES"),
           age = ifelse(age>110, age-100, abs(age)),
           mth_out = decimal_date(mdy(paste(mth_out,"1","2017"))),
           chronic_count = ifelse(chronic_count>=10,
                                  chronic_count-10,
                                  chronic_count)) %>% 
    filter(region != "Unknown" & rural != "Unknown" & gender %in% c("M","F"))

## Add a column indicate which CRD an individual received
crd = NA
for(i in 1:length(demo$id)){
        crd[i]=0
        if(demo$transport[i] == 1){
                crd[i] = 1
        }
        if(demo$fin_assis[i] == 1){
                crd[i] = 2
        }
         if(demo$lonely[i] == 1){
                crd[i] = 3
         }
         if(demo$food_insec[i] == 1){
                crd[i] = 4
         }
}
demo = demo %>% cbind(crd)

## Check: all NAs represent people from the control group
demo_df %>% filter(is.na(mth_out),
                crd ==0)

## Convert date to decimal year
loss = loss %>% mutate(time = decimal_date(time))
```

```{r Data Reduction}
demo = demo %>% 
    select(id,region,rural,is_lowincome,age,chronic_count,gender,mth_out,crd)
remove(claims,claims_df,demo_df,er,er_df,hospital,hospital_df,pcp,pcp_df,rx,rx_df,crd,i)
```

```{r Data Integration & Reduction 2}
## Join demo(features) with loss(responses)
impact = demo %>% inner_join(loss)

## Add a column to indicate if row is after_crd
impact = impact %>% 
    mutate(after_crd = ifelse(!is.na(mth_out),time >= mth_out,NA))

impact = impact %>% select(-mth_out)
```

```{r Visualization EDA, eval = T}
## Pair-wise relationship in demo
demo %>% select(-id) %>% ggpairs()

## Average utilization (aka # of claims) across the entire population over time
loss %>% group_by(time) %>% 
    summarize(a=mean(er_count),b=mean(hospital_count),
              c=mean(pcp_count),d=mean(rx_count),e=mean(total_count))%>% 
    ggplot() +
    geom_line(aes(x=time,y=a),color="red",size=1.5)+
    geom_line(aes(x=time,y=b),color="blue",size=1.5)+
    geom_line(aes(x=time,y=c),color="green",size=1.5)+
    geom_line(aes(x=time,y=d),color="black",size=1.5)+
    geom_line(aes(x=time,y=e),color="magenta",size=1.5)+
    geom_smooth(aes(x=time,y=a),color="black",method="lm",size=0.5)+
    geom_smooth(aes(x=time,y=b),color="black",method="lm",size=0.5)+
    geom_smooth(aes(x=time,y=c),color="black",method="lm",size=0.5)+
    geom_smooth(aes(x=time,y=d),color="black",method="lm",size=0.5)+
    geom_smooth(aes(x=time,y=e),color="black",method="lm",size=0.5)

## Average utilization (aka # of claims) across the entire population over time
loss %>% group_by(time) %>% 
    summarize(avg_agg_claim=mean(agg_claim),avg_avg_claim=mean(avg_claim))%>% 
    ggplot() +
    geom_line(aes(x=time,y=avg_agg_claim),color="red",size=1.5)+
    geom_line(aes(x=time,y=avg_avg_claim),color="blue",size=1.5)+
    geom_smooth(aes(x=time,y=avg_agg_claim),color="black",method="lm",size=0.5)+
    geom_smooth(aes(x=time,y=avg_avg_claim),color="black",method="lm",size=0.5)
```

```{r Build model for before and after outreach, eval=T}
## frequency model

```

```{r This block is not good, eval = F}

```



